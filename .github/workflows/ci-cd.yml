name: Deploy Q-EASY to AWS EC2

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # Allow manual trigger

env:
  APP_NAME: q-easy
  DEPLOY_PATH: /home/ubuntu/q-easy
  PYTHON_VERSION: "3.9"

jobs:
  validate-and-deploy:
    name: Validate, Test & Deploy
    runs-on: ubuntu-latest
    
    steps:
      # ============================================================
      # STEP 1: CHECKOUT CODE
      # ============================================================
      - name: üì• Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # ============================================================
      # STEP 2: SETUP PYTHON ENVIRONMENT
      # ============================================================
      - name: üêç Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      # ============================================================
      # STEP 3: INSTALL DEPENDENCIES
      # ============================================================
      - name: üì¶ Install Dependencies
        run: |
          sudo apt install -y python3 python3-pip python3-venv
          python3 -m venv venv
          source venv/bin/activate
          python -m pip install --upgrade pip
          pip install pandas numpy scikit-learn lightgbm streamlit plotly openpyxl joblib pytest flake8

      # ============================================================
      # STEP 4: CODE QUALITY CHECKS
      # ============================================================
      - name: üîç Run Code Quality Checks
        run: |
          echo "Running linting checks..."
          flake8 --max-line-length=120 --ignore=E501,W503 *.py || echo "Linting completed with warnings"

      # ============================================================
      # STEP 5: VALIDATE FILES EXIST
      # ============================================================
      - name: ‚úÖ Validate Required Files
        run: |
          echo "Checking for required files..."
          
          required_files=(
            "feature_engineering.py"
            "app.py"
            "best_lgbm_model.pkl"
            "scaler.pkl"
            "feature_names.pkl"
            "model_metadata.pkl"
          )
          
          missing_files=()
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "‚úÖ Found: $file"
            else
              echo "‚ùå Missing: $file"
              missing_files+=("$file")
            fi
          done
          
          if [ ${#missing_files[@]} -ne 0 ]; then
            echo "ERROR: Missing required files: ${missing_files[*]}"
            exit 1
          fi
          
          echo "All required files present!"

      # ============================================================
      # STEP 6: VALIDATE MODEL FILES
      # ============================================================
      - name: üß™ Validate Model Files
        run: |
          source venv/bin/activate
          python - <<EOF
          import joblib
          import sys
          
          print("Validating model files...")
          
          try:
              # Load model
              model = joblib.load('best_lgbm_model.pkl')
              print("‚úÖ Model loaded successfully")
              
              # Load scaler
              scaler = joblib.load('scaler.pkl')
              print("‚úÖ Scaler loaded successfully")
              
              # Load feature names
              feature_names = joblib.load('feature_names.pkl')
              print(f"‚úÖ Feature names loaded ({len(feature_names)} features)")
              
              # Load metadata
              metadata = joblib.load('model_metadata.pkl')
              print(f"‚úÖ Metadata loaded")
              print(f"   Model R¬≤: {metadata.get('model_r2', 'N/A')}")
              print(f"   Model RMSE: {metadata.get('model_rmse', 'N/A')}")
              
              # Validate metadata structure
              required_keys = [
                  'feature_names', 'numerical_cols_scaled', 'categorical_cols',
                  'original_categories', 'encoded_columns', 'model_rmse', 'model_r2'
              ]
              
              for key in required_keys:
                  if key not in metadata:
                      print(f"‚ùå Missing metadata key: {key}")
                      sys.exit(1)
              
              print("‚úÖ All model files validated successfully!")
              
          except Exception as e:
              print(f"‚ùå Validation failed: {e}")
              sys.exit(1)
          EOF

      # ============================================================
      # STEP 7: RUN INTEGRATION TESTS
      # ============================================================
      - name: üß™ Run Integration Tests
        run: |
          python - <<EOF
          import joblib
          import pandas as pd
          import numpy as np
          from feature_engineering import FeatureEngineer
          import sys
          
          print("Running integration tests...")
          
          try:
              # Load components
              model = joblib.load('best_lgbm_model.pkl')
              scaler = joblib.load('scaler.pkl')
              metadata = joblib.load('model_metadata.pkl')
              
              # Initialize FeatureEngineer
              fe = FeatureEngineer(metadata, scaler)
              
              # Test case
              test_inputs = {
                  'age': 45, 'gender': 'Male', 'temp': 37.0, 'hr': 75,
                  'rr': 16, 'bp_sys': 120, 'bp_dia': 80, 'spo2': 98,
                  'pain': 3, 'service': 'Emergency Medicine',
                  'complaint': 'Chest Pain', 'danger_signs': ['None'],
                  'triage_level': 3, 'is_pregnant': False, 'occupancy': 75,
                  'doctor_load': 8, 'shift_doctors': 5, 'shift_nurses': 10,
                  'shift_triage': 2, 'service_patients': 15, 'service_queue': 10,
                  'service_occupancy': 70, 'mri_avail': True, 'xray_avail': True,
                  'or_avail': True, 'outside_temp': 28.0, 'arrival_channel': 'Walk-in',
                  'shift': 'Morning', 'season': 'Summer', 'weather': 'Clear'
              }
              
              # Create features
              X = fe.create_features(test_inputs)
              print(f"‚úÖ Features created: shape {X.shape}")
              
              # Validate
              is_valid, msg = fe.validate_features(X)
              if not is_valid:
                  print(f"‚ùå Validation failed: {msg}")
                  sys.exit(1)
              print(f"‚úÖ Feature validation passed")
              
              # Make prediction
              log_wait = model.predict(X)[0]
              wait_minutes = np.exp(log_wait)
              
              if 5 <= wait_minutes <= 500:
                  print(f"‚úÖ Prediction successful: {wait_minutes:.0f} minutes")
              else:
                  print(f"‚ö†Ô∏è Warning: Unusual prediction: {wait_minutes:.0f} minutes")
              
              print("‚úÖ All integration tests passed!")
              
          except Exception as e:
              print(f"‚ùå Integration test failed: {e}")
              import traceback
              traceback.print_exc()
              sys.exit(1)
          EOF

      # ============================================================
      # STEP 8: CREATE DEPLOYMENT PACKAGE
      # ============================================================
      - name: üì¶ Create Deployment Package
        run: |
          echo "Creating deployment package..."
          
          # Create deployment directory
          mkdir -p deployment
          
          # Copy application files
          cp feature_engineering.py deployment/
          cp app.py deployment/app.py
          cp best_lgbm_model.pkl deployment/
          cp scaler.pkl deployment/
          cp feature_names.pkl deployment/
          cp model_metadata.pkl deployment/
          
          # Create requirements.txt
          cat > deployment/requirements.txt <<EOF
          pandas==2.0.3
          numpy==1.24.3
          scikit-learn==1.3.0
          lightgbm==4.0.0
          streamlit==1.28.0
          plotly==5.17.0
          openpyxl==3.1.2
          joblib==1.3.2
          EOF
          
          # Create start script
          cat > deployment/start.sh <<'EOF'
          #!/bin/bash
          
          # Activate virtual environment
          source venv/bin/activate
          
          # Start Streamlit
          nohup streamlit run app.py \
            --server.port=8501 \
            --server.address=0.0.0.0 \
            --server.headless=true \
            --server.enableCORS=false \
            --server.enableXsrfProtection=false \
            > streamlit.log 2>&1 &
          
          echo $! > streamlit.pid
          echo "Streamlit started with PID: $(cat streamlit.pid)"
          EOF
          
          chmod +x deployment/start.sh
          
          # Create stop script
          cat > deployment/stop.sh <<'EOF'
          #!/bin/bash
          
          if [ -f streamlit.pid ]; then
            PID=$(cat streamlit.pid)
            if ps -p $PID > /dev/null; then
              kill $PID
              echo "Stopped Streamlit (PID: $PID)"
            else
              echo "Streamlit process not running"
            fi
            rm streamlit.pid
          else
            # Fallback: kill all streamlit processes
            pkill -f "streamlit run"
            echo "Stopped all Streamlit processes"
          fi
          EOF
          
          chmod +x deployment/stop.sh
          
          # Create health check script
          cat > deployment/health_check.sh <<'EOF'
          #!/bin/bash
          
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8501)
          
          if [ "$response" = "200" ]; then
            echo "‚úÖ Application is healthy"
            exit 0
          else
            echo "‚ùå Application is not responding (HTTP $response)"
            exit 1
          fi
          EOF
          
          chmod +x deployment/health_check.sh
          
          echo "Deployment package created!"
          ls -la deployment/

      # ============================================================
      # STEP 9: SETUP SSH
      # ============================================================
      - name: üîë Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2_key.pem
          chmod 600 ~/.ssh/ec2_key.pem
          
          # Add EC2 to known hosts
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts || true

      # ============================================================
      # STEP 10: TEST SSH CONNECTION
      # ============================================================
      - name: üîó Test SSH Connection
        run: |
          echo "Testing SSH connection to EC2..."
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/ec2_key.pem \
            ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} \
            "echo '‚úÖ SSH connection successful!'"

      # ============================================================
      # STEP 11: PREPARE EC2 ENVIRONMENT
      # ============================================================
      - name: üõ†Ô∏è Prepare EC2 Environment
        run: |
          ssh -i ~/.ssh/ec2_key.pem ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            set -e
            
            echo "Preparing EC2 environment..."
            
            # Update system packages
            sudo apt-get update -qq
            sudo apt-get install nginx -y

            # Install Python and dependencies
            sudo apt-get install -y python3 python3-pip python3-venv
            
            # Create application directory
            mkdir -p ${{ env.DEPLOY_PATH }}
            
            echo "‚úÖ EC2 environment prepared!"
          ENDSSH

      # ============================================================
      # STEP 12: STOP EXISTING APPLICATION
      # ============================================================
      - name: üõë Stop Existing Application
        run: |
          ssh -i ~/.ssh/ec2_key.pem ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            echo "Stopping existing application..."
            
            cd ${{ env.DEPLOY_PATH }} || exit 0
            
            if [ -f stop.sh ]; then
              ./stop.sh || echo "No application to stop"
            else
              pkill -f "streamlit run" || echo "No Streamlit process found"
            fi
            
            # Wait for process to stop
            sleep 5
            
            echo "‚úÖ Existing application stopped"
          ENDSSH

      # ============================================================
      # STEP 13: DEPLOY APPLICATION
      # ============================================================
      - name: üöÄ Deploy Application to EC2
        run: |
          echo "Deploying application..."
          
          # Copy files to EC2
          scp -i ~/.ssh/ec2_key.pem -r deployment/* \
            ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}:${{ env.DEPLOY_PATH }}/
          
          echo "‚úÖ Files copied to EC2"

      # ============================================================
      # STEP 14: SETUP PYTHON ENVIRONMENT ON EC2
      # ============================================================
      - name: üêç Setup Python Environment on EC2
        run: |
          ssh -i ~/.ssh/ec2_key.pem ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            set -e
            
            cd ${{ env.DEPLOY_PATH }}
            
            echo "Setting up Python virtual environment..."
            
            # Create or update virtual environment
            if [ ! -d "venv" ]; then
              python3 -m venv venv
              echo "‚úÖ Virtual environment created"
            else
              echo "‚úÖ Virtual environment exists"
            fi
            
            # Activate and install dependencies
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
            
            echo "‚úÖ Dependencies installed"
          ENDSSH

      # ============================================================
      # STEP 15: VALIDATE DEPLOYMENT ON EC2
      # ============================================================
      - name: ‚úÖ Validate Deployment on EC2
        run: |
          ssh -i ~/.ssh/ec2_key.pem ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            set -e
            
            cd ${{ env.DEPLOY_PATH }}
            source venv/bin/activate
            
            echo "Validating deployment..."
            
            # Check all files exist
            required_files=(
              "app.py"
              "feature_engineering.py"
              "best_lgbm_model.pkl"
              "scaler.pkl"
              "feature_names.pkl"
              "model_metadata.pkl"
            )
            
            for file in "${required_files[@]}"; do
              if [ ! -f "$file" ]; then
                echo "‚ùå Missing file: $file"
                exit 1
              fi
            done
            
            echo "‚úÖ All files present"
            
            # Test model loading
            python3 << EOF
          import joblib
          import sys
          
          try:
              model = joblib.load('best_lgbm_model.pkl')
              scaler = joblib.load('scaler.pkl')
              metadata = joblib.load('model_metadata.pkl')
              print("‚úÖ Model files loaded successfully on EC2")
          except Exception as e:
              print(f"‚ùå Failed to load model: {e}")
              sys.exit(1)
          EOF
            
            echo "‚úÖ Deployment validation passed"
          ENDSSH

      # ============================================================
      # STEP 16: START APPLICATION
      # ============================================================
      - name: ‚ñ∂Ô∏è Start Application
        run: |
          ssh -i ~/.ssh/ec2_key.pem ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            set -e
            
            cd ${{ env.DEPLOY_PATH }}
            
            echo "Starting application..."
            
            # Start the application
            ./start.sh
            
            echo "‚úÖ Application started"
          ENDSSH

      # ============================================================
      # STEP 17: HEALTH CHECK
      # ============================================================
      - name: üè• Health Check
        run: |
          ssh -i ~/.ssh/ec2_key.pem ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            cd ${{ env.DEPLOY_PATH }}
            
            echo "Waiting for application to start..."
            sleep 10
            
            # Check if process is running
            if [ -f streamlit.pid ]; then
              PID=$(cat streamlit.pid)
              if ps -p $PID > /dev/null; then
                echo "‚úÖ Streamlit process is running (PID: $PID)"
              else
                echo "‚ùå Streamlit process not found"
                exit 1
              fi
            else
              echo "‚ùå PID file not found"
              exit 1
            fi
            
            # Test HTTP endpoint
            max_attempts=12
            attempt=0
            
            while [ $attempt -lt $max_attempts ]; do
              response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8501 || echo "000")
              
              if [ "$response" = "200" ]; then
                echo "‚úÖ Application is healthy (HTTP 200)"
                exit 0
              fi
              
              echo "Attempt $((attempt+1))/$max_attempts: HTTP $response"
              attempt=$((attempt+1))
              sleep 5
            done
            
            echo "‚ùå Health check failed after $max_attempts attempts"
            
            # Show logs for debugging
            echo "Last 50 lines of application log:"
            tail -n 50 streamlit.log
            
            exit 1
          ENDSSH

      # ============================================================
      # STEP 18: DEPLOYMENT SUMMARY
      # ============================================================
      - name: üìä Deployment Summary
        if: always()
        run: |
          ssh -i ~/.ssh/ec2_key.pem ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            cd ${{ env.DEPLOY_PATH }}
            
            echo ""
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo "               DEPLOYMENT SUMMARY"
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo ""
            echo "üìÅ Deployment Path: ${{ env.DEPLOY_PATH }}"
            echo "üêç Python Version: $(python3 --version)"
            echo "üì¶ Application Files:"
            ls -lh *.py *.pkl 2>/dev/null || echo "   (files not found)"
            echo ""
            
            if [ -f streamlit.pid ]; then
              PID=$(cat streamlit.pid)
              echo "‚ñ∂Ô∏è  Process Status: Running (PID: $PID)"
              echo "üåê Access URL: http://${{ secrets.EC2_HOST }}:8501"
            else
              echo "‚ö†Ô∏è  Process Status: Not Running"
            fi
            
            echo ""
            echo "üìù Recent Logs:"
            tail -n 20 streamlit.log 2>/dev/null || echo "   (no logs found)"
            echo ""
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          ENDSSH

      # ============================================================
      # STEP 19: CLEANUP
      # ============================================================
      - name: üßπ Cleanup
        if: always()
        run: |
          echo "Cleaning up..."
          rm -rf ~/.ssh/ec2_key.pem
          rm -rf deployment/
          echo "‚úÖ Cleanup complete"

      # ============================================================
      # STEP 20: SEND NOTIFICATION (Optional)
      # ============================================================
      - name: üìß Send Deployment Notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ DEPLOYMENT SUCCESSFUL!"
            echo "üåê Application URL: http://${{ secrets.EC2_HOST }}:8501"
          else
            echo "‚ùå DEPLOYMENT FAILED!"
            echo "Check the logs above for details."
          fi

# ============================================================
# REQUIRED GITHUB SECRETS
# ============================================================
# You need to add these secrets in GitHub:
# Settings -> Secrets and variables -> Actions -> New repository secret
#
# 1. EC2_SSH_KEY     - Your private SSH key content (entire .pem file)
# 2. EC2_HOST        - EC2 instance IP address or hostname
# 3. EC2_USERNAME    - SSH username (usually 'ubuntu' for Ubuntu instances)
# ============================================================